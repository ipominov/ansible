---
- name: Install SoftEther VPN Server
  hosts: centos

  tasks:

  - name: Install needful packages
    yum:
      name: "{{ item }}"
      state: present
    loop:
      - git
      - readline-devel
      - openssl-devel
      - make
      - gcc
  
  - name: Clone SoftEther repository from GitHub
    git:
      repo: https://github.com/SoftEtherVPN/SoftEtherVPN_Stable.git
      dest: /tmp/softether

  - name: Configure source code
    shell: ./configure
    args:
      chdir: /tmp/softether

  - name: Compile source code
    make:
      chdir: /tmp/softether

  - name: Copy SoftEther systemd unit 
    copy: src=/tmp/softether/systemd/softether-vpnserver.service dest=/etc/systemd/system/softether-vpnserver.service remote_src=yes directory_mode=yes

  - name: Copy SoftEther Server files
    copy: src=/tmp/softether/bin/vpnserver dest=/opt remote_src=yes directory_mode=yes  

  - name: Enable and start SoftEther VPN Service
    systemd:
      state: restarted
      daemon_reload: yes
      name: softether-vpnserver.service